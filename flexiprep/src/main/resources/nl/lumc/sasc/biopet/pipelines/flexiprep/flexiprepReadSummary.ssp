#import(nl.lumc.sasc.biopet.utils.summary.db.SummaryDb)
#import(nl.lumc.sasc.biopet.utils.summary.db.Schema.Sample)
#import(nl.lumc.sasc.biopet.utils.summary.db.Schema.Library)
#import(nl.lumc.sasc.biopet.utils.summary.db.SummaryDb._)
#import(nl.lumc.sasc.biopet.utils.summary.db.SummaryDb.Implicts._)
#import(nl.lumc.sasc.biopet.core.report.ReportPage)
#import(scala.concurrent.Await)
#import(scala.concurrent.duration.Duration)
#import(java.io.File)
#import(nl.lumc.sasc.biopet.pipelines.flexiprep.FlexiprepReport)
<%@ var summary: SummaryDb %>
<%@ var runId: Int %>
<%@ var sampleId: Option[Int] = None %>
<%@ var libId: Option[Int] = None %>
<%@ var rootPath: String %>
<%@ var outputDir: File %>
<%@ var showPlot: Boolean = false %>
<%@ var showTable: Boolean = true %>
<%@ var showIntro: Boolean = true %>
<%@ var multisample: Boolean = true %>
<%@ var allSamples: Seq[Sample] %>
<%@ var allLibraries: Seq[Library] %>
<%-- variables to be added to remove dependency upon futures --%>
<%@ var settings: Map[(Int, Int), Map[String, Option[Any]]] %>
<%@ var paired: Boolean %>
<%@ var seqstatPaths: Map[String, List[String]] %>
<%@ var seqstatPaths: Map[String, List[String]] %>
<%@ var seqstatStats: Map[String, Option[Any]] %>
<%@ var seqstatQcStats: Map[String, Option[Any]] %>
<%@ var clippingStats: Map[String, Option[Any]] %>
<%@ var trimmingStats: Map[String, Option[Any]] %>

#{
    val samples = sampleId.map(id => allSamples.filter(_.id == id)).getOrElse(allSamples)
    val libraries = libId.map(id => allLibraries.filter(_.id == id)).getOrElse(allLibraries)
    val settings = summary.getSettingsForLibraries(runId, "flexiprep", keyValues = Map(
    "skip_trim" -> List("skip_trim"), "skip_clip" -> List("skip_clip"), "paired" -> List("paired")))
    settings.count(_._2.getOrElse("skip_trim", None) == Some(true))
    val trimCount = settings.count(_._2.getOrElse("skip_trim", None) == Some(false))
    val clipCount = settings.count(_._2.getOrElse("skip_clip", None) == Some(false))
    val librariesCount = libraries.size

    val paired: Boolean = if (sampleId.isDefined && libId.isDefined)
        summary.getSettingKeys(runId, "flexiprep", NoModule, SampleId(sampleId.get), LibraryId(libId.get), keyValues = Map("paired" -> List("paired"))).getOrElse("paired", None) == Some(true)
    else settings.count(_._2.getOrElse("paired", None) == Some(true)) >= 1
}#
#if (showIntro)
    <br/>
    <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-6">
        <p>
            #if (trimCount == librariesCount && clipCount == librariesCount)
                You have selected both <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Alternative_clipping_strategies_.28Adaptor_clipping.29">adaptor clipping</a> and <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Sequence_Quality_Trimming">read trimming</a> as pre-processing steps
            #elseif (trimCount == librariesCount && clipCount == 0)
                You have selected only <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Sequence_Quality_Trimming">read trimming</a> as pre-processing step
            #elseif (trimCount == 0 && clipCount == librariesCount)
                You have selected only <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Alternative_clipping_strategies_.28Adaptor_clipping.29">adaptor clipping</a> as pre-processing step
            #elseif (trimCount == 0 && clipCount == 0)
                You have selected no pre-processing step to be performed
            #elseif (trimCount > 0 && clipCount == 0)
                You have chosen to perform <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Sequence_Quality_Trimming">read trimming</a> for some libraries, but not all.
            #elseif (trimCount == 0 && clipCount > 0)
                You have chosen to turn <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Alternative_clipping_strategies_.28Adaptor_clipping.29">adaptor clipping</a> for some libraries, but not all.
            #else
                You have chosen to turn <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Alternative_clipping_strategies_.28Adaptor_clipping.29">adaptor clipping</a> and <a href="https://en.wikibooks.org/wiki/Next_Generation_Sequencing_%28NGS%29/Pre-processing#Sequence_Quality_Trimming">read trimming</a> off for some libraries, but not all.
            #end
        </p>
        <p>
            #if(sampleId.isDefined && libId.isDefined)
                Here we show aggregated quality statistics for sequencing library ${libId} for sample ${sampleId}. It shows the total number of reads used after quality control, and the total number of reads discarded during quality control. This is done for both forward and reverse reads.
            #elseif(sampleId.isDefined)
                Here we show aggregated quality statistics for every sequencing library for sample ${sampleId}. It shows the total number of reads used after quality control, and the total number of reads discarded during quality control. This is done for both forward and reverse reads.
            #else
                Here we show aggregated quality statistics for every sequencing library. It shows the total number of reads used after quality control, and the total number of reads discarded during quality control. This is done for both forward and reverse reads.
                We show two plots; one for the forward read in the pair, and another one of the reverse read in the pair.
                Red denotes number of reads left after QC. Green denotes reads filtered by adaptor clipping.
                Blue denotes number of reads filtered by read trimming.
                Purple denotes the amount of <em>synced</em> reads. That is, reads removed in one orientation should be removed in the other as well to ensure correctness.
            #end
        </p>
    </div>
    </div>
#end

#if (showPlot)
    #{
        FlexiprepReport.readSummaryPlot(outputDir, "QC_Reads_R1","R1", summary, sampleId = sampleId)
        if (paired) FlexiprepReport.readSummaryPlot(outputDir, "QC_Reads_R2","R2", summary, sampleId = sampleId)
    }#
    <div class="panel-body">
    <div class="row">
        <div class="col-sm-6 col-md-6">
            <img src="QC_Reads_R1.png" class="img-responsive">
        </div>
        #if (paired)
        <div class="col-sm-6 col-md-6">
            <img src="QC_Reads_R2.png" class="img-responsive">
        </div>
        #end
    </div>

    </div>
    <div class="panel-footer">
    #if (showTable)
        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#QC_ReadsTable">Hide table</button>
    #else
        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#QC_ReadsTable">Show table</button>
    #end

    <a href="QC_Reads_R1.tsv"><button type="button" class="btn btn-info"><i class="glyphicon glyphicon-cloud-download"></i> R1 reads stats</button></a>
    #if (paired)
    <a href="QC_Reads_R2.tsv"><button type="button" class="btn btn-info"><i class="glyphicon glyphicon-cloud-download"></i> R2 reads stats</button></a>
    #end
    </div>
#end

<div class="panel-body collapse #if (showTable)in#end" id="QC_ReadsTable">

<!-- Table -->
<table class="table sortable-theme-bootstrap">
    <thead><tr>
        <th>Sample</th>
        <th colspan="2">Library</th>
        <th>Before QC</th>
        <th>Clipping</th>
        <th>Trimming</th>
        #if (paired == true) <th>Out of Sync</th> #end
        <th>After QC</th>
    </tr></thead>
    <tbody>
        #for (sample <- samples.sortBy(_.name))
            #{
                val sampleRowspan = {
                libraries.filter(_.sampleId == sample.id).size +
                 settings.filter(_._1._1 == sample.id).count(_._2("paired").getOrElse(false) == true)
                }
            }#
            <tr><td rowspan="${sampleRowspan}">
            #if (multisample)
                <a href="${rootPath}Samples/${sample.name}/index.html">${sample.name}</a>
            #else
                ${sample.name}
            #end
            </td>
            #for (lib <- libraries.filter(_.sampleId == sample.id))
                #{ val paired = settings.filter(_._1._1 == sample.id).filter(_._1._2 == lib.id).head._2("paired") == Some(true) }#
                <td #if (paired == true) rowspan="2" #end>
                #if (multisample)
                    <a href="${rootPath}Samples/${sample.name}/Libraries/${lib.name}/index.html">${lib.name}</a>
                #else
                    ${lib.name}
                #end
                </td>
                #{ val reads = if (paired == true) List("R1", "R2") else List("R1") }#
                #for (read <- reads)
                    #if (read == "R2") </tr><tr> #end
                    #{
                        val seqstatPaths = Map("num_total" -> List("reads", "num_total"))
                        val seqstatStats = summary.getStatKeys(runId, "flexiprep", "seqstat_" + read, sample = sample.id, library = lib.id, keyValues = seqstatPaths)
                        val seqstatQcStats = summary.getStatKeys(runId, "flexiprep", "seqstat_" + read + "_qc", sample = sample.id, library = lib.id, keyValues = seqstatPaths)

                        val clippingPaths = Map("num_reads_discarded_too_short" -> List("num_reads_discarded_too_short"),
                        "num_reads_discarded_too_long" -> List("num_reads_discarded_too_long"))
                        val clippingStats = summary.getStatKeys(runId, "flexiprep", "clipping_" + read, sample = sample.id, library = lib.id, keyValues = clippingPaths)

                        val trimmingPaths = Map("num_reads_discarded" -> List("num_reads_discarded_total"))
                        val trimmingStats = summary.getStatKeys(runId, "flexiprep", "trimming_" + read, sample = sample.id, library = lib.id, keyValues = trimmingPaths)

                        val beforeTotal = seqstatStats("num_total").getOrElse(0).toString.toLong
                        val afterTotal = seqstatQcStats("num_total").getOrElse(0).toString.toLong
                        val clippingDiscardedToShort = clippingStats("num_reads_discarded_too_short").getOrElse(0).toString.toLong
                        val clippingDiscardedToLong = clippingStats("num_reads_discarded_too_long").getOrElse(0).toString.toLong
                        val trimmingDiscarded = trimmingStats("num_reads_discarded").getOrElse(0).toString.toLong
                    }#
                    <td>${read}</td>
                    <td>${beforeTotal}</td>
                    <td>${clippingDiscardedToShort + clippingDiscardedToLong}</td>
                    <td>${trimmingDiscarded}</td>
                    #if (paired == true) <td>${beforeTotal - clippingDiscardedToShort - clippingDiscardedToLong - trimmingDiscarded - afterTotal}</td> #end
                    <td>${afterTotal}</td>
                #end
                </tr>
            #end
        #end
    </tbody>

</table>
</div>
